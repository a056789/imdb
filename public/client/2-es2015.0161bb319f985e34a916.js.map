{"version":3,"sources":["webpack:///src/app/site/people/crupdate-person/state/crupdate-person-state-actions.ts","webpack:///src/app/models/person.ts","webpack:///src/app/site/people/crupdate-person/state/crupdate-person-state.ts","webpack:///src/app/site/people/crupdate-person/crupdate-person-page.component.html","webpack:///src/app/site/people/crupdate-person/crupdate-person-routing.module.ts","webpack:///src/app/site/people/crupdate-person/crupdate-person-page.component.ts","webpack:///src/app/site/people/crupdate-person/crupdate-person.module.ts"],"names":["LoadPerson","id","type","DetachCredit","CreatePerson","payload","UpdatePerson","ResetState","Person","params","name","this","CrupdatePersonState","people","titles","state","person","loading","credits","ctx","action","patchState","get","pipe","tap","response","flattenCredits","create","finalize","update","getState","removeCredit","newCredits","filter","credit","pivot","flatCredits","Object","keys","forEach","key","push","defaults","routes","path","component","CrupdatePersonPageComponent","store","toast","router","fb","route","uploadQueue","datatable","poster$","BehaviorSubject","personForm","group","poster","popularity","description","known_for","birth_place","birth_date","death_date","gender","allow_update","init","subscribe","loadPerson","select","data","valueChanges","value","next","dispatch","destroy","types","image","then","upload","start","uri","httpParams","diskPrefix","patchValue","fileEntry","url","selectSnapshot","navigate","includes","split","replace","open","PERSON_UPDATE_SUCCESS","PERSON_CREATE_SUCCESS","CREDIT_REMOVE_SUCCESS","submit","uploadPoster","permissions","CrupdatePersonRoutingModule","forChild","CrupdatePersonModule","forFeature"],"mappings":"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","file":"x","sourcesContent":["import {Person} from '../../../../models/person';\r\n\r\nexport class LoadPerson {\r\n    static readonly type = '[CrupdatePerson] Load Person';\r\n    constructor(public id: number) {}\r\n}\r\n\r\nexport class DetachCredit {\r\n    static readonly type = '[CrupdatePerson] Detach Credit';\r\n    constructor(public id: number) {}\r\n}\r\n\r\nexport class CreatePerson {\r\n    static readonly type = '[CrupdatePerson] Create Person';\r\n    constructor(public payload: Partial<Person>) {}\r\n}\r\n\r\nexport class UpdatePerson {\r\n    static readonly type = '[CrupdatePerson] Update Person';\r\n    constructor(public payload: Partial<Person>) {}\r\n}\r\n\r\nexport class ResetState {\r\n    static readonly type = '[CrupdatePerson] Reset State';\r\n}\r\n","import {MEDIA_TYPE} from '../site/media-type';\r\nimport {Title} from './title';\r\n\r\nexport class Person {\r\n    id: number;\r\n    name: string;\r\n    poster: string;\r\n    known_for?: string;\r\n    gender?: string;\r\n    birth_date: string;\r\n    death_date: string;\r\n    birth_place: string;\r\n    credits?: Title[];\r\n    popular_credits?: Title[];\r\n    views?: number;\r\n    popularity?: number;\r\n    updated_at?: string;\r\n    description: string;\r\n    type: MEDIA_TYPE.PERSON;\r\n\r\n    constructor(params: object = {}) {\r\n        for (const name in params) {\r\n            this[name] = params[name];\r\n        }\r\n    }\r\n}\r\n","import {Action, Selector, State, StateContext} from '@ngxs/store';\r\nimport {Person} from '../../../../models/person';\r\nimport {finalize, tap} from 'rxjs/operators';\r\nimport {\r\n    CreatePerson,\r\n    DetachCredit,\r\n    LoadPerson,\r\n    ResetState,\r\n    UpdatePerson\r\n} from './crupdate-person-state-actions';\r\nimport {PeopleService} from '../../people.service';\r\nimport {TitleCredit} from '../../../../models/title';\r\nimport {TitlesService} from '../../../titles/titles.service';\r\nimport {Injectable} from '@angular/core';\r\n\r\ninterface CrupdatePersonStateModel {\r\n    person: Person;\r\n    credits: TitleCredit[];\r\n    loading: boolean;\r\n}\r\n\r\n@State<CrupdatePersonStateModel>({\r\n    name: 'crupdatePerson',\r\n    defaults: {\r\n        person: new Person(),\r\n        credits: [],\r\n        loading: false,\r\n    },\r\n})\r\n@Injectable()\r\nexport class CrupdatePersonState {\r\n    @Selector()\r\n    static person(state: CrupdatePersonStateModel) {\r\n        return state.person;\r\n    }\r\n\r\n    @Selector()\r\n    static loading(state: CrupdatePersonStateModel) {\r\n        return state.loading;\r\n    }\r\n\r\n    @Selector()\r\n    static credits(state: CrupdatePersonStateModel) {\r\n        return state.credits;\r\n    }\r\n\r\n    constructor(\r\n        private people: PeopleService,\r\n        private titles: TitlesService,\r\n    ) {}\r\n\r\n    @Action(LoadPerson)\r\n    loadPerson(ctx: StateContext<CrupdatePersonStateModel>, action: LoadPerson) {\r\n        ctx.patchState({loading: true});\r\n        return this.people.get(action.id).pipe(tap(response => {\r\n            ctx.patchState({\r\n                person: response.person,\r\n                credits: this.flattenCredits(response.credits),\r\n                loading: false\r\n            });\r\n        }));\r\n    }\r\n\r\n    @Action(CreatePerson)\r\n    createPerson(ctx: StateContext<CrupdatePersonStateModel>, action: CreatePerson) {\r\n        ctx.patchState({loading: true});\r\n        return this.people.create(action.payload).pipe(\r\n            finalize(() => ctx.patchState({loading: false})),\r\n            tap(response => ctx.patchState({person: response.person}))\r\n        );\r\n    }\r\n\r\n    @Action(UpdatePerson)\r\n    updatePerson(ctx: StateContext<CrupdatePersonStateModel>, action: UpdatePerson) {\r\n        ctx.patchState({loading: true});\r\n        return this.people.update(ctx.getState().person.id, action.payload).pipe(\r\n            finalize(() => ctx.patchState({loading: false})),\r\n            tap(response => ctx.patchState({person: response.person}))\r\n        );\r\n    }\r\n\r\n    @Action(DetachCredit)\r\n    removeCredit(ctx: StateContext<CrupdatePersonStateModel>, action: DetachCredit) {\r\n        ctx.patchState({loading: true});\r\n        return this.titles.removeCredit(action.id).pipe(\r\n            tap(() => {\r\n                const newCredits = ctx.getState().credits.filter(credit => {\r\n                    return credit.pivot.id !== action.id;\r\n                });\r\n                ctx.patchState({credits: newCredits});\r\n            }),\r\n            finalize(() => ctx.patchState({loading: false}))\r\n        );\r\n    }\r\n\r\n    @Action(ResetState)\r\n    resetState(ctx: StateContext<CrupdatePersonStateModel>) {\r\n        ctx.patchState({\r\n            person: new Person(),\r\n            credits: [],\r\n            loading: false,\r\n        });\r\n    }\r\n\r\n    private flattenCredits(credits: object) {\r\n        const flatCredits = [];\r\n        Object.keys(credits).forEach(key => {\r\n            flatCredits.push(...credits[key]);\r\n        });\r\n        return flatCredits;\r\n    }\r\n}\r\n","<mat-tab-group animationDuration=\"0ms\" class=\"material-panel\" color=\"accent\">\r\n    <mat-tab [label]=\"'Primary Facts' | trans\">\r\n        <form class=\"primary-facts-panel\" (ngSubmit)=\"submit()\" [formGroup]=\"personForm\" ngNativeValidate>\r\n            <div class=\"left-col\">\r\n                <media-image [src]=\"poster$ | async\" size=\"medium\"></media-image>\r\n                <button type=\"submit\" mat-raised-button color=\"accent\" class=\"submit-button\" trans>Save</button>\r\n            </div>\r\n            <div class=\"right-col many-inputs\">\r\n                <div class=\"inline-container many-inputs\">\r\n                    <div class=\"input-container\">\r\n                        <label for=\"name\" trans>Name</label>\r\n                        <input type=\"text\" formControlName=\"name\" id=\"name\" required>\r\n                    </div>\r\n                    <div class=\"input-container\">\r\n                        <label for=\"known_for\" trans>Known For</label>\r\n                        <input type=\"text\" formControlName=\"known_for\" id=\"known_for\">\r\n                    </div>\r\n                </div>\r\n\r\n                <div class=\"input-container\">\r\n                    <label for=\"poster\" trans>Image</label>\r\n                    <div class=\"input-with-action action-left\">\r\n                        <button type=\"button\" mat-flat-button color=\"accent\" (click)=\"uploadPoster()\" [matTooltip]=\"'Upload poster' | trans\">\r\n                            <mat-icon svgIcon=\"file-upload\"></mat-icon>\r\n                        </button>\r\n                        <input type=\"text\" formControlName=\"poster\" id=\"poster\" minlength=\"1\" maxlength=\"250\">\r\n                    </div>\r\n                </div>\r\n\r\n                <div class=\"input-container\">\r\n                    <label for=\"description\" trans>Biography</label>\r\n                    <textarea id=\"description\" formControlName=\"description\" cdkTextareaAutosize cdkAutosizeMinRows=\"10\" cdkAutosizeMaxRows=\"100\"></textarea>\r\n                </div>\r\n\r\n                <div class=\"inline-container many-inputs\">\r\n                    <div class=\"input-container\">\r\n                        <label for=\"gender\" trans>Gender</label>\r\n                        <select id=\"gender\" formControlName=\"gender\">\r\n                            <option [ngValue]=\"null\">-</option>\r\n                            <option value=\"male\" trans>Male</option>\r\n                            <option value=\"female\" trans>Female</option>\r\n                        </select>\r\n                    </div>\r\n                    <div class=\"input-container\">\r\n                        <label for=\"birth_date\" trans>Birth Date</label>\r\n                        <input type=\"date\" id=\"birth_date\" formControlName=\"birth_date\">\r\n                    </div>\r\n                    <div class=\"input-container\">\r\n                        <label for=\"death_date\" trans>Death Date</label>\r\n                        <input type=\"date\" id=\"death_date\" formControlName=\"death_date\">\r\n                    </div>\r\n                </div>\r\n\r\n                <div class=\"inline-container many-inputs\">\r\n                    <div class=\"input-container\">\r\n                        <label for=\"popularity\" trans>Popularity</label>\r\n                        <input type=\"number\" formControlName=\"popularity\" id=\"popularity\" min=\"1\" max=\"1000\" step=\"0.1\">\r\n                    </div>\r\n\r\n                    <div class=\"input-container\">\r\n                        <label for=\"birth_place\" trans>Birth Place</label>\r\n                        <input type=\"text\" id=\"birth_place\" formControlName=\"birth_place\">\r\n                    </div>\r\n\r\n                    <div class=\"input-container\">\r\n                        <label for=\"allow_update\" trans>Allow Auto Update</label>\r\n                        <select formControlName=\"allow_update\" id=\"allow_update\" required>\r\n                            <option [ngValue]=\"true\" trans>Yes</option>\r\n                            <option [ngValue]=\"false\" trans>No</option>\r\n                        </select>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </form>\r\n    </mat-tab>\r\n    <mat-tab [label]=\"'Credits' | trans\">\r\n        <div class=\"responsive-table\">\r\n            <datatable-header></datatable-header>\r\n            <table class=\"material-table\">\r\n                <thead>\r\n                <tr>\r\n                    <th table-sort-header=\"name\" trans>Credit</th>\r\n                    <th table-sort-header=\"pivot.character\" trans>Character</th>\r\n                    <th table-sort-header=\"pivot.department\" trans>Department</th>\r\n                    <th table-sort-header=\"pivot.job\" trans>Job</th>\r\n                    <th></th>\r\n                </tr>\r\n                </thead>\r\n                <tbody>\r\n                <tr *ngFor=\"let credit of datatable.data$ | async\">\r\n                    <td>\r\n                        <div class=\"column-with-image\">\r\n                            <media-image [src]=\"credit.poster\" size=\"small\"></media-image>\r\n                            <span>{{credit.name}}</span>\r\n                        </div>\r\n                    </td>\r\n                    <td data-label=\"Character\" class=\"capitalize\">{{credit.pivot?.character ? credit.pivot.character : '-'}}</td>\r\n                    <td data-label=\"Department\" class=\"capitalize\">{{credit.pivot?.department ? credit.pivot.department : '-'}} </td>\r\n                    <td data-label=\"Job\" class=\"capitalize\">{{credit.pivot?.job ? credit.pivot.job : '-'}}</td>\r\n                    <td class=\"edit-column\">\r\n                        <button type=\"button\" mat-icon-button (click)=\"detachCredit(credit)\">\r\n                            <mat-icon svgIcon=\"close\"></mat-icon>\r\n                        </button>\r\n                    </td>\r\n                </tr>\r\n                </tbody>\r\n            </table>\r\n\r\n            <no-results-message *ngIf=\"!(datatable.data$ | async).length\" svgImage=\"awards.svg\">\r\n                <span primary-text trans>Nothing to display.</span>\r\n            </no-results-message>\r\n        </div>\r\n    </mat-tab>\r\n</mat-tab-group>\r\n\r\n<loading-indicator [isVisible]=\"loading$ | async\" class=\"overlay\"></loading-indicator>\r\n","import {NgModule} from '@angular/core';\nimport {RouterModule, Routes} from '@angular/router';\nimport {CrupdatePersonPageComponent} from './crupdate-person-page.component';\n\nconst routes: Routes = [\n    {\n        path: '',\n        component: CrupdatePersonPageComponent,\n        data: {permissions: ['people.update']}\n    },\n];\n\n@NgModule({\n  imports: [RouterModule.forChild(routes)],\n  exports: [RouterModule]\n})\nexport class CrupdatePersonRoutingModule { }\n","import {ChangeDetectionStrategy, Component, OnDestroy, OnInit} from '@angular/core';\r\nimport {Select, Store} from '@ngxs/store';\r\nimport {ActivatedRoute, Router} from '@angular/router';\r\nimport {\r\n    CreatePerson,\r\n    DetachCredit,\r\n    LoadPerson,\r\n    ResetState,\r\n    UpdatePerson\r\n} from './state/crupdate-person-state-actions';\r\nimport {CrupdatePersonState} from './state/crupdate-person-state';\r\nimport {FormBuilder} from '@angular/forms';\r\nimport {BehaviorSubject, Observable} from 'rxjs';\r\nimport {TitleCredit} from '../../../models/title';\r\nimport {MESSAGES} from '../../../toast-messages';\r\nimport {UploadQueueService} from '../../../../common/uploads/upload-queue/upload-queue.service';\r\nimport {Toast} from '../../../../common/core/ui/toast.service';\r\nimport {openUploadWindow} from '../../../../common/uploads/utils/open-upload-window';\r\nimport {UploadInputTypes} from '../../../../common/uploads/upload-input-config';\r\nimport {DatatableService} from '../../../../common/datatable/datatable.service';\r\n\r\n@Component({\r\n    selector: 'crupdate-person-page',\r\n    templateUrl: './crupdate-person-page.component.html',\r\n    styleUrls: ['./crupdate-person-page.component.scss'],\r\n    changeDetection: ChangeDetectionStrategy.OnPush,\r\n    providers: [\r\n        UploadQueueService,\r\n        DatatableService,\r\n    ],\r\n})\r\nexport class CrupdatePersonPageComponent implements OnInit, OnDestroy {\r\n    @Select(CrupdatePersonState.loading) loading$: Observable<boolean>;\r\n    @Select(CrupdatePersonState.credits) credits$: Observable<TitleCredit[]>;\r\n    public poster$ = new BehaviorSubject<string>(null);\r\n\r\n    public personForm = this.fb.group({\r\n        name: [''],\r\n        poster: [''],\r\n        popularity: [''],\r\n        description: [''],\r\n        known_for: [''],\r\n        birth_place: [''],\r\n        birth_date: [''],\r\n        death_date: [''],\r\n        gender: [null],\r\n        allow_update: [true],\r\n    });\r\n\r\n    constructor(\r\n        private store: Store,\r\n        private toast: Toast,\r\n        private router: Router,\r\n        private fb: FormBuilder,\r\n        private route: ActivatedRoute,\r\n        private uploadQueue: UploadQueueService,\r\n        public datatable: DatatableService<TitleCredit>,\r\n    ) {}\r\n\r\n    ngOnInit() {\r\n        this.datatable.init();\r\n        this.route.params.subscribe(params => {\r\n            this.loadPerson(params);\r\n        });\r\n\r\n        this.store.select(CrupdatePersonState.credits).subscribe(credits => {\r\n            this.datatable.data = credits;\r\n        });\r\n\r\n        this.personForm.get('poster').valueChanges.subscribe(value => {\r\n            this.poster$.next(value);\r\n        });\r\n    }\r\n\r\n    ngOnDestroy() {\r\n        this.store.dispatch(new ResetState());\r\n        this.datatable.destroy();\r\n    }\r\n\r\n    public uploadPoster() {\r\n        openUploadWindow({types: [UploadInputTypes.image]}).then(upload => {\r\n            const params = {\r\n                uri: 'uploads/images',\r\n                httpParams: {\r\n                    diskPrefix: 'media-images/posters'\r\n                },\r\n            };\r\n            this.uploadQueue.start(upload, params).subscribe(response => {\r\n                this.personForm.patchValue({\r\n                    poster: response.fileEntry.url\r\n                });\r\n            });\r\n        });\r\n    }\r\n\r\n    private loadPerson(params: {id?: string}) {\r\n        if ( ! params.id) return;\r\n        this.store.dispatch(new LoadPerson(+params.id)).subscribe(() => {\r\n            const person = this.store.selectSnapshot(CrupdatePersonState.person);\r\n            this.personForm.patchValue(person);\r\n            this.poster$.next(person.poster);\r\n        });\r\n    }\r\n\r\n    public submit() {\r\n        const person = this.store.selectSnapshot(CrupdatePersonState.person);\r\n        const response = person.id ?\r\n            this.store.dispatch(new UpdatePerson(this.personForm.value)) :\r\n            this.store.dispatch(new CreatePerson(this.personForm.value));\r\n\r\n        response.subscribe(() => {\r\n            this.router.navigate([this.router.url.includes('admin') ? 'admin/people' : this.router.url.split('?')[0].replace('/edit', '')]);\r\n            this.toast.open(person.id ? MESSAGES.PERSON_UPDATE_SUCCESS : MESSAGES.PERSON_CREATE_SUCCESS);\r\n        });\r\n    }\r\n\r\n    public detachCredit(credit: TitleCredit) {\r\n        if ( ! credit.pivot) return;\r\n        this.store.dispatch(new DetachCredit(credit.pivot.id))\r\n            .subscribe(() => {\r\n                this.toast.open(MESSAGES.CREDIT_REMOVE_SUCCESS);\r\n            });\r\n    }\r\n}\r\n","import {NgModule} from '@angular/core';\nimport {CommonModule} from '@angular/common';\nimport {CrupdatePersonRoutingModule} from './crupdate-person-routing.module';\nimport {CrupdatePersonPageComponent} from './crupdate-person-page.component';\nimport {MatTabsModule} from '@angular/material/tabs';\nimport {TranslationsModule} from '../../../../common/core/translations/translations.module';\nimport {FormsModule, ReactiveFormsModule} from '@angular/forms';\nimport {MediaImageModule} from '../../shared/media-image/media-image.module';\nimport {MatButtonModule} from '@angular/material/button';\nimport {MatTooltipModule} from '@angular/material/tooltip';\nimport {TextFieldModule} from '@angular/cdk/text-field';\nimport {MatIconModule} from '@angular/material/icon';\nimport {NoResultsMessageModule} from '../../../../common/core/ui/no-results-message/no-results-message.module';\nimport {LoadingIndicatorModule} from '../../../../common/core/ui/loading-indicator/loading-indicator.module';\nimport {NgxsModule} from '@ngxs/store';\nimport {CrupdatePersonState} from './state/crupdate-person-state';\nimport {DatatableModule} from '../../../../common/datatable/datatable.module';\n\n\n@NgModule({\n    declarations: [\n        CrupdatePersonPageComponent,\n    ],\n    imports: [\n        CommonModule,\n        CrupdatePersonRoutingModule,\n        TranslationsModule,\n        FormsModule,\n        ReactiveFormsModule,\n        MediaImageModule,\n        NoResultsMessageModule,\n        LoadingIndicatorModule,\n        DatatableModule,\n\n        NgxsModule.forFeature([\n            CrupdatePersonState\n        ]),\n\n        // material\n        MatTabsModule,\n        MatButtonModule,\n        MatIconModule,\n        MatTooltipModule,\n        TextFieldModule,\n    ]\n})\nexport class CrupdatePersonModule {\n}\n"]}